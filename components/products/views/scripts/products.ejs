

<script>

    extend.products = function(){

        scope.view.upload_text = "Upload Image"

        watch['new.category'] = function(data){
            scope.get('product_categories/'+data).then((category)=>{
                scope.new.sub_category = ''
                scope.sub_categories = category.sub_categories
            })
        }

        scope.editProduct = function(collection){

            contextCloseAll()

            if (scope.view.key >= 0){
                scope.new = scope[collection][scope.view.key]
            } else {
                scope.new = {}
            }


            if (scope.new.category){
                let sub_cat = scope.new.sub_category+''
                scope.get('product_categories/'+scope.new.category).then((category)=>{
                    scope.sub_categories = category.sub_categories
                    view.update('sub_categories')
                    scope.new.sub_category = sub_cat
                })
            }

            if (!scope.new.gallery){
                scope.new.gallery = []
            }

            scope.openModal('show_product_edit')
            view.update('new')

        }

        scope.uploadImg = function(image, obj, input){

            let payload = {
                base64: image,
                file_name: "test-image-upload",
                file_path: "products"
            }

            scope.view.upload_text = 'Uploading...'
            view.update('view.upload_text')

            http.post('/api/image',payload).then((data) => {

                if (obj){
                    scope.push(obj,data)
                    scope.saveItem('<%- table %>',scope.new, true)
                    view.update(obj)
                }
                scope.view.upload_text = 'Upload Image'
                view.update('view.upload_text')
            }).catch((err)=>{
                scope.notify(err,'error')
            })

        }

    }

</script>
